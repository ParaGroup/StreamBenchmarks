.PHONY: release debug profile perf all clean

# common options and environment
CC           := g++
CXXFLAGS     := -MP -MMD -std=c++17 -I lib/
LDFLAGS      := -pthread -lcrypto
SOURCES      := $(shell find . -path ./external -prune -o -name '*.cpp' -print)
OBJECTS      := $(patsubst %.cpp, %.o, $(shell find lib/ -name '*.cpp'))
BINARIES     := $(patsubst %.cpp, %, $(wildcard bin/*.cpp))
DEPENDENCIES := $(SOURCES:.cpp=.d)

# WindFlow and FastFlow dependencies
WINDFLOW_ROOT ?= $(HOME)/WindFlow
FASTFLOW_ROOT ?= $(HOME)/fastflow
CXXFLAGS      += -isystem $(WINDFLOW_ROOT)/wf/ -isystem $(FASTFLOW_ROOT)

# FastFlow queue setup (XXX same as Storm TOPOLOGY_EXECUTOR_RECEIVE_BUFFER_SIZE)
CXXFLAGS += -DFF_BOUNDED_BUFFER -DDEFAULT_BUFFER_CAPACITY=32786 -DNDEBUG

# build configurations
release debug profile perf: all
release: CXXFLAGS += -O3 -g
debug:   CXXFLAGS += -O3 -g -Werror -DDEBUG
profile: CXXFLAGS += -O3 -g -DTRACE_WINDFLOW
perf:    CXXFLAGS += -O3 -g

# build all binaries
all: $(BINARIES)
$(BINARIES): %: %.o $(OBJECTS)

# cleanup
clean:
	@find . -name '*.o' -delete
	@$(RM) $(DEPENDENCIES) $(BINARIES)

# include files generated by the -MMD option
-include $(DEPENDENCIES)
